<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìö StudyVault - –¢–≤–æ—è –±–∞–∑–∞ –∑–Ω–∞–Ω—å</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #2d3748;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }
      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 2rem;
      }
      .header-content h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
      }
      .header-content p {
        font-size: 1.2rem;
        opacity: 0.9;
      }
      .section {
        background: white;
        margin: 2rem 0;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .section h2 {
        color: #667eea;
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
      }
      .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      .search-bar input {
        flex: 1;
        padding: 1rem 1.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        background: #f7fafc;
      }
      .search-bar input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
      }
      .search-bar button,
      .upload-btn {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .search-bar button:hover,
      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(72, 187, 120, 0.4);
      }
      .upload-form {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
      }
      .file-input-wrapper {
        flex: 1;
        min-width: 250px;
      }
      .file-input-wrapper input[type="file"] {
        width: 100%;
        padding: 1rem;
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        background: #f7fafc;
        cursor: pointer;
      }
      .file-input-wrapper input[type="file"]:hover {
        border-color: #667eea;
        background: white;
      }
      .upload-form select {
        padding: 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        background: white;
        cursor: pointer;
      }
      .library-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
      }
      .stat-card .number {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
      }
      .stat-card .label {
        opacity: 0.9;
        font-size: 0.9rem;
      }
      /* üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ */
      #filesList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }
      .file-item {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
      }
      .file-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }
      .file-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
      }
      .file-info {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }
      .file-preview {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        font-size: 0.85rem;
        color: #4a5568;
        max-height: 80px;
        overflow: hidden;
        font-family: monospace;
      }
      .search-result {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s;
      }
      .search-result:hover {
        border-color: #48bb78;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .search-result-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
      }
      .search-result-info {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 1rem;
      }
      .search-result-snippet {
        background: #f7fafc;
        border-left: 4px solid #48bb78;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        font-family: monospace;
        font-size: 0.9rem;
      }
      .btn-primary {
        display: inline-block;
        background: linear-gradient(135deg, #9f7aea, #805ad5);
        color: white;
        text-decoration: none;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(159, 122, 234, 0.4);
        text-decoration: none;
        color: white;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      }
      .modal-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.3rem;
      }
      .close-btn {
        font-size: 1.5rem;
        cursor: pointer;
        background: none;
        border: none;
        color: white;
        padding: 0.5rem;
        border-radius: 50%;
      }
      .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .modal-body {
        padding: 1.5rem;
        max-height: 50vh;
        overflow: auto;
      }
      .file-content {
        background: #f8f9fa;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.5rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        color: #2d3748;
      }
      .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        background: #f7fafc;
      }
      .modal-footer button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-download {
        background: #48bb78;
        color: white;
      }
      .btn-copy {
        background: #17a2b8;
        color: white;
      }
      .btn-close {
        background: #6c757d;
        color: white;
      }
      .btn-delete {
        background: #e53e3e;
        color: white;
      }
      .btn-delete:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(232, 62, 62, 0.4);
      }
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        .header-content h1 {
          font-size: 2rem;
        }
        .search-bar,
        .upload-form {
          flex-direction: column;
        }
        .library-stats {
          grid-template-columns: repeat(2, 1fr);
        }
        #filesList {
          grid-template-columns: 1fr;
        }
        .modal-content {
          width: 95%;
          margin: 10% auto;
        }
      }
      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      .loading::after {
        content: "...";
        animation: pulse 2s infinite;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-content">
        <h1>üìö StudyVault</h1>
        <p>–¢–≤–æ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –±–∞–∑–∞ –∑–Ω–∞–Ω—å</p>
      </div>
    </header>

    <div class="container">
      <!-- üîç –°–µ–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ -->
      <div class="section">
        <h2>üîç –®–≤–∏–¥–∫–∏–π –ø–æ—à—É–∫</h2>
        <div class="search-bar">
          <input
            type="text"
            id="searchInput"
            placeholder="–ó–Ω–∞–π—Ç–∏ –∫–æ–Ω—Å–ø–µ–∫—Ç–∏, —à–ø–∞—Ä–≥–∞–ª–∫–∏, –∫–æ–¥..."
            autocomplete="off"
          />
          <button onclick="performSearch()">üîç –®—É–∫–∞—Ç–∏</button>
        </div>

        <div id="searchResults"></div>
      </div>

      <div class="section">
        <h2>üì§ –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</h2>
        <div class="upload-form">
          <div class="file-input-wrapper">
            <input
              type="file"
              id="fileInput"
              accept=".txt,.md,.py,.js,.html,.css,.json,.sql"
              multiple
            />
          </div>
          <select id="categorySelect">
            <option value="–∫–æ–Ω—Å–ø–µ–∫—Ç–∏">üìã –ö–æ–Ω—Å–ø–µ–∫—Ç–∏</option>
            <option value="—à–ø–∞—Ä–≥–∞–ª–∫–∏">üóíÔ∏è –®–ø–∞—Ä–≥–∞–ª–∫–∏</option>
            <option value="–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–¥–∞">üíª –ö–æ–¥</option>
            <option value="—Ç–µ—Ä–º–∏–Ω—ã">üìñ –¢–µ—Ä–º—ñ–Ω–∏</option>
            <option value="–æ–±—â–∏–µ" selected>üìÑ –ó–∞–≥–∞–ª—å–Ω—ñ</option>
          </select>
          <button class="upload-btn" onclick="uploadFile()">üì§ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </div>

      <div class="section">
        <h2>üìö –¢–≤–æ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞</h2>
        <div class="library-stats">
          <div class="stat-card">
            <div class="number" id="stat-total">0</div>
            <div class="label">üìÑ –í—Å—å–æ–≥–æ</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-notes">0</div>
            <div class="label">üìã –ö–æ–Ω—Å–ø–µ–∫—Ç–∏</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-code">0</div>
            <div class="label">üíª –ö–æ–¥</div>
          </div>
          <div class="stat-card">
            <div class="number" id="stat-sheets">0</div>
            <div class="label">üóíÔ∏è –®–ø–∞—Ä–≥–∞–ª–∫–∏</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>üì¨ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h2>
        <p style="text-align: center; margin: 1rem 0">
          <a href="/message.html" class="btn-primary">
            üì§ –ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
          </a>
        </p>
      </div>

      <div class="section">
        <h2>–û—Å—Ç–∞–Ω–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</h2>

        <div style="text-align: center; margin-bottom: 1rem">
          <button
            onclick="clearAllFiles()"
            style="
              background: #e53e3e;
              color: white;
              border: none;
              padding: 0.5rem 1rem;
              border-radius: 8px;
              margin: 0.5rem;
              cursor: pointer;
            "
          >
            üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Ñ–∞–π–ª–∏
          </button>
          <button
            onclick="exportFiles()"
            style="
              background: #17a2b8;
              color: white;
              border: none;
              padding: 0.5rem 1rem;
              border-radius: 8px;
              margin: 0.5rem;
              cursor: pointer;
            "
          >
            üì• –ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏
          </button>
        </div>

        <div id="filesList">
          <div class="loading">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤</div>
        </div>
      </div>
    </div>

    <div id="fileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">üìÑ –§–∞–π–ª</h3>
          <button class="close-btn" onclick="closeFileModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div id="modalFileInfo" class="file-info">üìä –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ñ–∞–π–ª</div>
          <pre id="modalFileContent" class="file-content">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</pre>
        </div>
        <div class="modal-footer">
          <button class="btn-download" onclick="downloadCurrentFile()">
            –°–∫–∞—á–∞—Ç–∏
          </button>
          <button class="btn-copy" onclick="copyFileContent()">
            –ö–æ–ø—ñ—é–≤–∞—Ç–∏
          </button>
          <button
            class="btn-delete"
            onclick="deleteCurrentFile()"
            style="background: #e53e3e"
          >
            –í–∏–¥–∞–ª–∏—Ç–∏
          </button>
          <button class="btn-close" onclick="closeFileModal()">
            ‚ùå –ó–∞–∫—Ä–∏—Ç–∏
          </button>
        </div>
      </div>
    </div>

    <script>
      // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ñ–∞–π–ª–∞–º–∏
      class StudyVaultStorage {
        constructor() {
          this.storageKey = "studyvault_files";
          this.indexKey = "studyvault_index";
        }

        getAllFiles() {
          const stored = localStorage.getItem(this.storageKey);
          return stored ? JSON.parse(stored) : [];
        }

        saveFile(fileData) {
          const files = this.getAllFiles();
          const existingIndex = files.findIndex(
            (f) => f.filename === fileData.filename
          );

          if (existingIndex >= 0) {
            files[existingIndex] = fileData;
          } else {
            files.push(fileData);
          }

          localStorage.setItem(this.storageKey, JSON.stringify(files));
          this.updateSearchIndex();
          console.log("‚úÖ –§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ:", fileData.filename);
        }

        updateSearchIndex() {
          const files = this.getAllFiles();
          const index = {};

          files.forEach((file) => {
            const words = this.extractWords(file.content + " " + file.filename);
            words.forEach((word) => {
              if (!index[word]) {
                index[word] = [];
              }
              if (!index[word].includes(file.filename)) {
                index[word].push(file.filename);
              }
            });
          });

          localStorage.setItem(this.indexKey, JSON.stringify(index));
        }

        extractWords(text) {
          return text
            .toLowerCase()
            .replace(/[^\w\s–∞-—è—ë]/g, " ")
            .split(/\s+/)
            .filter((word) => word.length > 2);
        }

        searchFiles(query) {
          if (!query.trim()) return [];

          const index = JSON.parse(localStorage.getItem(this.indexKey) || "{}");
          const files = this.getAllFiles();
          const searchWords = this.extractWords(query);
          const results = new Map();

          searchWords.forEach((word) => {
            if (index[word]) {
              index[word].forEach((filename) => {
                const file = files.find((f) => f.filename === filename);
                if (file) {
                  const score = (results.get(filename) || 0) + 1;
                  results.set(filename, score);
                }
              });
            }
          });

          return Array.from(results.entries())
            .sort((a, b) => b[1] - a[1])
            .map(([filename]) => files.find((f) => f.filename === filename))
            .slice(0, 10);
        }
      }

      // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
      const storage = new StudyVaultStorage();
      let currentFileData = null;

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
      async function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const categorySelect = document.getElementById("categorySelect");

        if (!fileInput.files || fileInput.files.length === 0) {
          alert("‚ùå –û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è!");
          return;
        }

        const files = Array.from(fileInput.files);
        let successCount = 0;

        for (const file of files) {
          try {
            const content = await readFileContent(file);
            const fileData = {
              filename: file.name,
              content: content,
              size: file.size,
              category: categorySelect.value,
              modified: new Date().toISOString(),
              type: file.type || "text/plain",
            };

            storage.saveFile(fileData);
            successCount++;
          } catch (error) {
            console.error("‚ùå –ü–æ–º–∏–ª–∫–∞:", file.name, error);
            alert(
              `‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ "${file.name}": ${error.message}`
            );
          }
        }

        if (successCount > 0) {
          alert(`‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ñ–∞–π–ª—ñ–≤: ${successCount}`);
          fileInput.value = "";
          loadFilesList();
          updateStats();
        }
      }

      // –ß–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É
      function readFileContent(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () => reject(new Error("–ù–µ –≤–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª"));
          reader.readAsText(file, "UTF-8");
        });
      }

      //–ü–æ—à—É–∫
      function performSearch() {
        const searchInput = document.getElementById("searchInput");
        const query = searchInput.value.trim();

        if (!query) {
          document.getElementById("searchResults").innerHTML =
            '<p style="text-align: center; color: #666;">üìù –í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É</p>';
          return;
        }

        const results = storage.searchFiles(query);
        displaySearchResults(results, query);
      }

      // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É
      function displaySearchResults(results, query) {
        const container = document.getElementById("searchResults");

        if (results.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h3>üòî –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p>–ó–∞ –∑–∞–ø–∏—Ç–æ–º "${query}" —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –Ω–µ–º–∞—î</p>
                    </div>
                `;
          return;
        }

        let html = `<h3 style="color: #48bb78; margin-bottom: 1rem;">
                üéØ –ó–Ω–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤: ${results.length}
            </h3>`;

        results.forEach((file) => {
          const snippet = createSearchSnippet(file.content, query);
          const categoryEmoji = getCategoryEmoji(file.category);

          html += `
                    <div class="search-result" onclick="showFileModal(${JSON.stringify(
                      file
                    ).replace(/"/g, "&quot;")})">
                        <div class="search-result-title">
                            ${categoryEmoji} ${file.filename}
                        </div>
                        <div class="search-result-info">
                            üìÅ ${file.category} | üìä ${formatBytes(file.size)} |
                            üìÖ ${new Date(file.modified).toLocaleDateString()}
                        </div>
                        <div class="search-result-snippet">
                            ${snippet}
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–Ω—ñ–ø–µ—Ç—É
      function createSearchSnippet(content, query) {
        const maxLength = 200;
        const queryWords = query.toLowerCase().split(/\s+/);
        const lowerContent = content.toLowerCase();

        let bestPosition = 0;
        queryWords.forEach((word) => {
          const pos = lowerContent.indexOf(word);
          if (pos !== -1) {
            bestPosition = Math.max(bestPosition, pos);
          }
        });

        const start = Math.max(0, bestPosition - maxLength / 2);
        const end = Math.min(content.length, start + maxLength);

        let snippet = content.substring(start, end);

        if (start > 0) snippet = "..." + snippet;
        if (end < content.length) snippet = snippet + "...";

        queryWords.forEach((word) => {
          if (word.length > 2) {
            const regex = new RegExp(`(${escapeRegex(word)})`, "gi");
            snippet = snippet.replace(regex, "<mark>$1</mark>");
          }
        });

        return snippet;
      }

      // –ï–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª—ñ–≤
      function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      function loadFilesList() {
        const files = storage.getAllFiles();
        const container = document.getElementById("filesList");

        if (files.length === 0) {
          container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <h3>üìÇ –§–∞–π–ª—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</h3>
                        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–µ—Ä—à–∏–π —Ñ–∞–π–ª, —â–æ–± –ø–æ—á–∞—Ç–∏!</p>
                    </div>
                `;
          return;
        }

        // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑–∞ –¥–∞—Ç–æ—é –∑–º—ñ–Ω–∏
        const sortedFiles = files.sort(
          (a, b) => new Date(b.modified) - new Date(a.modified)
        );

        let html = "";
        sortedFiles.forEach((file) => {
          const preview =
            file.content.length > 100
              ? file.content.substring(0, 100) + "..."
              : file.content;
          const categoryEmoji = getCategoryEmoji(file.category);

          html += `
                    <div class="file-item">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div class="file-name" onclick="showFileModal(${JSON.stringify(
                              file
                            ).replace(
                              /"/g,
                              "&quot;"
                            )})" style="cursor: pointer; flex: 1;">
                                ${categoryEmoji} ${file.filename}
                            </div>
                            <button onclick="deleteFile('${
                              file.filename
                            }')" style="background: #e53e3e; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;" title="–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª">
                                üóëÔ∏è
                            </button>
                        </div>
                        <div class="file-info">
                            üìÅ ${file.category} | üìä ${formatBytes(file.size)} |
                            üìÖ ${new Date(file.modified).toLocaleDateString()}
                        </div>
                        <div class="file-preview" onclick="showFileModal(${JSON.stringify(
                          file
                        ).replace(/"/g, "&quot;")})" style="cursor: pointer;">
                            ${escapeHtml(preview)}
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      function updateStats() {
        const files = storage.getAllFiles();
        const stats = {
          total: files.length,
          notes: files.filter((f) => f.category === "–∫–æ–Ω—Å–ø–µ–∫—Ç–∏").length,
          code: files.filter((f) => f.category === "–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–¥–∞").length,
          sheets: files.filter((f) => f.category === "—à–ø–∞—Ä–≥–∞–ª–∫–∏").length,
        };

        document.getElementById("stat-total").textContent = stats.total;
        document.getElementById("stat-notes").textContent = stats.notes;
        document.getElementById("stat-code").textContent = stats.code;
        document.getElementById("stat-sheets").textContent = stats.sheets;
      }

      // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –µ–º–æ–¥–∑—ñ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function getCategoryEmoji(category) {
        const emojis = {
          –∫–æ–Ω—Å–ø–µ–∫—Ç–∏: "üìã",
          —à–ø–∞—Ä–≥–∞–ª–∫–∏: "üóíÔ∏è",
          "–ø—Ä–∏–∫–ª–∞–¥–∏-–∫–æ–¥—É": "üíª",
          —Ç–µ—Ä–º—ñ–Ω–∏: "üìñ",
          –∑–∞–≥–∞–ª—å–Ω—ñ: "üìÑ",
        };
        return emojis[category] || "üìÑ";
      }

      //–§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É
      function formatBytes(bytes) {
        if (bytes === 0) return "0 –±–∞–π—Ç";
        const k = 1024;
        const sizes = ["–±–∞–π—Ç", "–ö–ë", "–ú–ë", "–ì–ë"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return text.replace(/[&<>"']/g, (m) => map[m]);
      }

      // –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û - –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
      function showFileModal(fileData) {
        currentFileData = fileData;

        const modal = document.getElementById("fileModal");
        const title = document.getElementById("modalTitle");
        const info = document.getElementById("modalFileInfo");
        const content = document.getElementById("modalFileContent");

        if (title) title.textContent = `üìÑ ${fileData?.filename || "–§–∞–π–ª"}`;
        if (info) {
          info.innerHTML = `
                    üìä –†–æ–∑–º—ñ—Ä: ${formatBytes(fileData?.size || 0)} |
                    üìÅ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${fileData?.category || "–Ω–µ–≤—ñ–¥–æ–º–∞"} |
                    üìÖ –ó–º—ñ–Ω–µ–Ω–æ: ${
                      fileData?.modified
                        ? new Date(fileData.modified).toLocaleDateString()
                        : "–Ω–µ–≤—ñ–¥–æ–º–æ"
                    }
                `;
        }
        if (content) content.textContent = fileData?.content || "–ù–µ–º–∞—î –≤–º—ñ—Å—Ç—É";
        if (modal) modal.style.display = "block";
      }

      function closeFileModal() {
        const modal = document.getElementById("fileModal");
        if (modal) {
          modal.style.display = "none";
        }
        currentFileData = null;
      }

      function downloadCurrentFile() {
        if (!currentFileData) {
          alert("‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —Å–∫–∞—á—É–≤–∞–Ω–Ω—è");
          return;
        }

        const blob = new Blob([currentFileData.content], {
          type: "text/plain;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = currentFileData.filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function copyFileContent() {
        if (!currentFileData) {
          alert("‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è");
          return;
        }

        try {
          await navigator.clipboard.writeText(currentFileData.content);
          alert("‚úÖ –í–º—ñ—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!");
        } catch (error) {
          console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è:", error);
          alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤–º—ñ—Å—Ç");
        }
      }

      function deleteCurrentFile() {
        if (!currentFileData) {
          alert("‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è");
          return;
        }

        if (
          confirm(
            `üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª "${currentFileData.filename}"?\n\n‚ö†Ô∏è –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!`
          )
        ) {
          const files = storage.getAllFiles();
          const filteredFiles = files.filter(
            (f) => f.filename !== currentFileData.filename
          );

          localStorage.setItem(
            "studyvault_files",
            JSON.stringify(filteredFiles)
          );
          storage.updateSearchIndex();

          // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
          closeFileModal();

          // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          loadFilesList();
          updateStats();

          alert(`‚úÖ –§–∞–π–ª "${currentFileData.filename}" –≤–∏–¥–∞–ª–µ–Ω–æ!`);
          console.log("üóëÔ∏è –§–∞–π–ª –≤–∏–¥–∞–ª–µ–Ω–æ:", currentFileData.filename);
        }
      }

      //  –í–ò–î–ê–õ–ï–ù–ù–Ø –§–ê–ô–õ–Ü–í
      function deleteFile(filename) {
        if (
          confirm(
            `‚ùå –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª "${filename}"?\n\n–¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏!`
          )
        ) {
          const files = storage.getAllFiles();
          const filteredFiles = files.filter((f) => f.filename !== filename);

          localStorage.setItem(
            "studyvault_files",
            JSON.stringify(filteredFiles)
          );
          storage.updateSearchIndex();

          loadFilesList();
          updateStats();

          alert(`‚úÖ –§–∞–π–ª "${filename}" –≤–∏–¥–∞–ª–µ–Ω–æ!`);
          console.log("üóëÔ∏è –§–∞–π–ª –≤–∏–¥–∞–ª–µ–Ω–æ:", filename);
        }
      }

      function clearAllFiles() {
        if (
          confirm(
            "‚ùå –í–ò–î–ê–õ–ò–¢–ò –í–°–Ü –§–ê–ô–õ–ò?\n\n‚ö†Ô∏è –¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ –≤–∞—à—ñ –∫–æ–Ω—Å–ø–µ–∫—Ç–∏, —à–ø–∞—Ä–≥–∞–ª–∫–∏ —Ç–∞ –∫–æ–¥!\n–¶—é –¥—ñ—é –ù–ï–ú–û–ñ–õ–ò–í–û —Å–∫–∞—Å—É–≤–∞—Ç–∏!\n\n–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?"
          )
        ) {
          if (
            confirm(
              "üö® –û–°–¢–ê–ù–ù–Ø –ü–ï–†–ï–í–Ü–†–ö–ê!\n\n–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü –Ω–∞–≤—á–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏?\n–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ —Å–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±–∏—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç!"
            )
          ) {
            localStorage.removeItem("studyvault_files");
            localStorage.removeItem("studyvault_index");

            loadFilesList();
            updateStats();

            alert(
              "‚úÖ –í—Å—ñ —Ñ–∞–π–ª–∏ –≤–∏–¥–∞–ª–µ–Ω–æ!\n–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–æ–≤—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏."
            );
            console.log("üßπ –í—Å—ñ —Ñ–∞–π–ª–∏ –æ—á–∏—â–µ–Ω–æ");
          }
        }
      }

      function exportFiles() {
        const files = storage.getAllFiles();
        if (files.length === 0) {
          alert("üìÇ –ù–µ–º–∞—î —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É");
          return;
        }

        const exportData = {
          exported: new Date().toISOString(),
          studyvault_version: "1.0",
          files: files,
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `studyvault-export-${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(
          `‚úÖ –ï–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${files.length} —Ñ–∞–π–ª—ñ–≤!\n–ó–±–µ—Ä–µ–∂—ñ—Ç—å —Ü–µ–π —Ñ–∞–π–ª –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.`
        );
        console.log("üì¶ –§–∞–π–ª–∏ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ:", files.length);
      }

      //  –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ StudyVault —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ");

        loadFilesList();
        updateStats();

        // –ü–æ—à—É–∫ –ø–æ Enter
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              performSearch();
            }
          });
        }
      });

      // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–æ –∫–ª—ñ–∫—É –≤–Ω–µ –µ–≥–æ
      window.onclick = function (event) {
        const modal = document.getElementById("fileModal");
        if (event.target === modal) {
          closeFileModal();
        }
      };

      // –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–æ –∫–ª–∞–≤—ñ—à—ñ Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeFileModal();
        }
      });

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
      setTimeout(() => {
        if (storage.getAllFiles().length === 0) {
          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã
          const testFiles = [
            {
              filename: "python_basics.py",
              content:
                '# Python Basics\n\ndef hello_world():\n    print("Hello, StudyVault!")\n    return "Success"\n\nif __name__ == "__main__":\n    hello_world()',
              size: 147,
              category: "–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–¥–∞",
              modified: new Date().toISOString(),
              type: "text/python",
            },
            {
              filename: "mongodb_notes.md",
              content:
                "# MongoDB –ö–æ–Ω—Å–ø–µ–∫—Ç\n\n## –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:\n- db.collection.find()\n- db.collection.insertOne()\n- db.collection.updateOne()\n- db.collection.deleteOne()\n\n## –ü—Ä–∏–∫–ª–∞–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:\n```javascript\nconst client = new MongoClient(uri);\n```",
              size: 289,
              category: "–∫–æ–Ω—Å–ø–µ–∫—Ç–∏",
              modified: new Date(Date.now() - 86400000).toISOString(),
              type: "text/markdown",
            },
          ];

          testFiles.forEach((file) => storage.saveFile(file));
          loadFilesList();
          updateStats();
          console.log("‚úÖ –î–æ–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏");
        }
      }, 1000);

      console.log("‚úÖ StudyVault –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ç–∞ –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏!");
    </script>
  </body>
</html>
